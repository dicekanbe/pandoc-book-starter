\documentclass[
  book, % 本
  paper=a5paper, % A5版(148mm*210mm)
  jafontsize=12Q, % 和文フォントサイズを12級に
  baselineskip=20.4H, % 行送りを1.7文字=20.4歯に
  line_length=37zw, % 1行の文字数を37文字に（版面幅は37*12Q=111mm）
  number_of_lines=35, % 1ページあたりの行数を35行に（版面高さは(35+(35-1)*0.7)*12Q=178.5mm）
  twoside, % 両面印刷（奇数ページと偶数ページのデザインを変える）
  openany, % 章の区切りを左右両ページで許す
  gutter=20mm, % ノド側（綴じ側）の余白を20mmに
  headfoot_sidemargin=-8mm, % 柱とノンブルを版面の横8mm分外側に配置
  headfoot_verticalposition=8mm, % 柱とノンブルを版面の下8mm分外側に配置
]{jlreq}

% ページスタイルの設定
% ノンブルを小口側下に配置
\NewPageStyle{mainstyle}{nombre_position=bottom-fore-edge}
\pagestyle{mainstyle}

% 画像とグラフィックスの処理
\usepackage{graphicx}
\usepackage{adjustbox}

% pandocの画像処理用コマンド
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=0.8\textwidth,height=0.2\textheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother

% pandocboundedコマンドの定義 - 画像を見やすいサイズで表示
\newcommand{\pandocbounded}[1]{%
  \adjustbox{width=\textwidth, max height=0.2\textheight, min width=0.6\textwidth, center}{#1}%
}

\usepackage{longtable,booktabs,array}
\usepackage{calc}

\usepackage[]{tcolorbox}
\tcbuselibrary{breakable,theorems,skins}

\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  hidelinks,
  pdfcreator={LaTeX via pandoc}}
\urlstyle{same} % disable monospaced font for URLs
\usepackage{color}
\usepackage{fancyvrb}

% 箇条書き
\def\tightlist{\itemsep1pt\parskip0pt\parsep0pt}

% ここからソースコードを挿入するための設定
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
% Add ',fontsize=\small' for more characters per line
\newenvironment{Shaded}{}{}
\newcommand{\AlertTok}[1]{\textbf{#1}}
\newcommand{\AnnotationTok}[1]{\textit{#1}}
\newcommand{\AttributeTok}[1]{#1}
\newcommand{\BaseNTok}[1]{#1}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{#1}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textit{#1}}
\newcommand{\ConstantTok}[1]{#1}
\newcommand{\ControlFlowTok}[1]{\textbf{#1}}
\newcommand{\DataTypeTok}[1]{\underline{#1}}
\newcommand{\DecValTok}[1]{#1}
\newcommand{\DocumentationTok}[1]{\textit{#1}}
\newcommand{\ErrorTok}[1]{\textbf{#1}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{#1}
\newcommand{\FunctionTok}[1]{#1}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textit{#1}}
\newcommand{\KeywordTok}[1]{\textbf{#1}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{#1}
\newcommand{\OtherTok}[1]{#1}
\newcommand{\PreprocessorTok}[1]{\textbf{#1}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{#1}
\newcommand{\SpecialStringTok}[1]{#1}
\newcommand{\StringTok}[1]{#1}
\newcommand{\VariableTok}[1]{#1}
\newcommand{\VerbatimStringTok}[1]{#1}
\newcommand{\WarningTok}[1]{\textit{#1}}
\setlength{\emergencystretch}{3em} % prevent overfull lines
\usepackage{fvextra}
\usepackage{xcolor}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}, breaklines, breaknonspaceingroup, breakanywhere, frame=single, rulecolor=\color{gray}, framesep=3pt, fontsize=\small}
% ここまでソースコードを挿入するための設定

% フォントを変更可能にする
\usepackage{luatexja-fontspec}

% 振り仮名を振れるようにする
\usepackage{luatexja-ruby}

% 高度なデザインのためのTikZ
\usepackage{tikz}
\usetikzlibrary{shapes.geometric, arrows.meta, decorations.pathmorphing}

% 見出しデザインのカスタマイズ
\usepackage{titlesec}

% 章（Chapter）のデザイン
\titleformat{\chapter}[display]
  {\normalfont\huge\bfseries\centering$if(heading-style.chapter-color)$\color{$heading-style.chapter-color$}$endif$}
  {\chaptertitlename\thechapter}
  {20pt}
  {\Huge}

% 節（Section）のデザイン - パターン1: シンプルな線付き
% \titleformat{\section}
%   {\normalfont\Large\bfseries}
%   {\thesection}
%   {1em}
%   {\hrule height 0.4pt \vspace{2pt}}

% 節（Section）のデザイン - パターン2: カラーボックス付き（元のデザイン）
% \titleformat{\section}
%   {\normalfont\Large\bfseries}
%   {\llap{\colorbox{$if(heading-style.section-bg-color)$$heading-style.section-bg-color$$else$black$endif$}{\textcolor{$if(heading-style.section-text-color)$$heading-style.section-text-color$$else$white$endif$}{\arabic{section}}}}\hspace{0.5em}}
%   {0pt}
%   {}

% 節（Section）のデザイン - パターン3: 下線付き
\titleformat{\section}
  {\normalfont\Large\bfseries}
  {\thesection}
  {1em}
  {\underline}

% 節（Section）のデザイン - パターン4: 左側に色付きバー
% \titleformat{\section}
%   {\normalfont\Large\bfseries}
%   {\llap{\textcolor{blue}{\rule{3pt}{1.2em}}\hspace{5pt}\thesection}}
%   {1em}
%   {}

% 節（Section）のデザイン - パターン5: 上下に線、中央寄せ
% \titleformat{\section}
%   {\normalfont\Large\bfseries\centering}
%   {}
%   {0pt}
%   {\vspace{-1em}\hrule height 0.8pt \vspace{0.5em}\thesection\quad}
%   [\vspace{0.5em}\hrule height 0.8pt]

% 節（Section）のデザイン - パターン6: 角丸ボックス
% \titleformat{\section}
%   {\normalfont\Large\bfseries}
%   {\llap{\fcolorbox{gray}{lightgray}{\makebox[2em]{\thesection}}\hspace{0.5em}}}
%   {0pt}
%   {}

% 節（Section）のデザイン - パターン7: 番号を大きく、タイトルを小さく
% \titleformat{\section}
%   {\normalfont\bfseries}
%   {\fontsize{24}{28}\selectfont\color{gray}\thesection}
%   {0.5em}
%   {\fontsize{16}{20}\selectfont}

% 節（Section）のデザイン - パターン8: 装飾的な線と番号
% \titleformat{\section}
%   {\normalfont\Large\bfseries}
%   {\llap{\textcolor{$if(heading-style.section-bg-color)$$heading-style.section-bg-color$$else$blue$endif$}{\rule{0.5pt}{1.2em}}\hspace{3pt}\colorbox{$if(heading-style.section-bg-color)$$heading-style.section-bg-color$$else$blue$endif$}{\textcolor{$if(heading-style.section-text-color)$$heading-style.section-text-color$$else$white$endif$}{\small\thesection}}\hspace{0.5em}}}
%   {0pt}
%   {}

% 節（Section）のデザイン - パターン9: 影付きボックス
% \titleformat{\section}
%   {\normalfont\Large\bfseries}
%   {\llap{\fcolorbox{black}{white}{\makebox[2em]{\thesection}}\hspace{0.5em}}}
%   {0pt}
%   {}

% 節（Section）のデザイン - パターン10: 二重線
% \titleformat{\section}
%   {\normalfont\Large\bfseries}
%   {\thesection}
%   {1em}
%   {}
%   [\vspace{0.2em}{\hrule height 0.4pt}\vspace{0.1em}{\hrule height 0.4pt}]

% 節（Section）のデザイン - パターン11: 角丸のカラーボックス
% \titleformat{\section}
%   {\normalfont\Large\bfseries}
%   {\llap{\tikz[baseline=(text.base)]{%
%     \node[rectangle, rounded corners=3pt, fill=$if(heading-style.section-bg-color)$$heading-style.section-bg-color$$else$blue$endif$, 
%           text=$if(heading-style.section-text-color)$$heading-style.section-text-color$$else$white$endif$, 
%           inner sep=3pt, minimum width=1.5em] (text) {\footnotesize\thesection};%
%   }\hspace{0.5em}}}
%   {0pt}
%   {}

% 節（Section）のデザイン - パターン12: 矢印付き
% \titleformat{\section}
%   {\normalfont\Large\bfseries}
%   {\llap{\tikz[baseline=(text.base)]{%
%     \node[single arrow, fill=$if(heading-style.section-bg-color)$$heading-style.section-bg-color$$else$blue$endif$, 
%           text=$if(heading-style.section-text-color)$$heading-style.section-text-color$$else$white$endif$, 
%           inner sep=2pt, minimum width=1.5em, single arrow head extend=0.1em] (text) {\footnotesize\thesection};%
%   }\hspace{0.5em}}}
%   {0pt}
%   {}

% 節（Section）のデザイン - パターン13: 波線付き
% \titleformat{\section}
%   {\normalfont\Large\bfseries}
%   {\thesection}
%   {1em}
%   {}
%   [\vspace{0.3em}\tikz{\draw[thick, $if(heading-style.section-bg-color)$$heading-style.section-bg-color$$else$blue$endif$, 
%      decoration={snake, amplitude=0.5mm, segment length=2mm}, decorate] (0,0) -- (\textwidth,0);}]

% 節（Section）のデザイン - パターン14: 六角形
% \titleformat{\section}
%   {\normalfont\Large\bfseries}
%   {\llap{\tikz[baseline=(text.base)]{%
%     \node[regular polygon, regular polygon sides=6, fill=$if(heading-style.section-bg-color)$$heading-style.section-bg-color$$else$blue$endif$, 
%           text=$if(heading-style.section-text-color)$$heading-style.section-text-color$$else$white$endif$, 
%           inner sep=2pt, minimum width=1.5em] (text) {\footnotesize\thesection};%
%   }\hspace{0.5em}}}
%   {0pt}
%   {}

% 節（Section）のデザイン - パターン15: グラデーション風
% \titleformat{\section}
%   {\normalfont\Large\bfseries}
%   {\llap{\tikz[baseline=(text.base)]{%
%     \shade[left color=$if(heading-style.section-bg-color)$$heading-style.section-bg-color$$else$blue$endif$, 
%            right color=$if(heading-style.section-bg-color)$$heading-style.section-bg-color$$else$blue$endif$!30] 
%            (0,0) rectangle (1.5em,1.2em);%
%     \node[text=$if(heading-style.section-text-color)$$heading-style.section-text-color$$else$white$endif$] at (0.75em,0.6em) {\footnotesize\thesection};%
%   }\hspace{0.5em}}}
%   {0pt}
%   {}


% 小節（Subsection）のデザイン
\titleformat{\subsection}
  {\normalfont\large\bfseries}
  {\thesubsection}
  {1em}
  {$if(heading-style.subsection-underline)$\underline$endif$}

% 段落（Subsubsection）のデザイン
\titleformat{\subsubsection}
  {\normalfont\normalsize\bfseries}
  {\thesubsubsection}
  {1em}
  {}

% 目次に出すのを節（見出しレベル1）までにする
\setcounter{tocdepth}{1}

\begin{document}

$if(title)$
\title{$title$}
$endif$
$if(author)$
\author{$for(author)$$author$$sep$ \and $endfor$}
$endif$
$if(date)$
\date{$date$}
$else$
\date{}
$endif$
\maketitle

\tableofcontents

$body$

% 改ページ
\clearpage

$if(colophon)$
% 奥付ここから
\null\vfill
\section*{$colophon.book-title$$if(colophon.subtitle)$\\{\small $colophon.subtitle$}$endif$}
\hrule\vskip.5mm\hrule\vskip3mm
\begin{tabular}{ll}
$if(colophon.publish-date)$$colophon.publish-date$$endif$& $if(colophon.edition)$$colophon.edition$$endif$\\
\end{tabular}
\vskip1em
\begin{tabular}{ll}
$if(colophon.author-label)$$colophon.author-label$$endif$& $if(colophon.publisher)$$colophon.publisher$$endif$\\
$if(colophon.printer-label)$$colophon.printer-label$$endif$& $if(colophon.printer)$$colophon.printer$$endif$\\
$if(colophon.illustrator-label)$$if(colophon.illustrator)$$colophon.illustrator-label$& $colophon.illustrator$$endif$$endif$\\
\end{tabular}
\vskip1em
\begin{tabular}{ll}
$if(colophon.email-label)$$colophon.email-label$$endif$ & $if(colophon.email)$\href{mailto:$colophon.email$}{\nolinkurl{$colophon.email$}}$endif$\\
$if(colophon.web-label)$$colophon.web-label$$endif$ & $if(colophon.web)$\url{$colophon.web$}$endif$\\
\end{tabular}
\vskip3mm\hrule\vskip3mm
$if(colophon.disclaimer)${\scriptsize $colophon.disclaimer$}$endif$
% 奥付ここまで
$endif$
\end{document}
